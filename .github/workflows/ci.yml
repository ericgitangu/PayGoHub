name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true

jobs:
  # ============================================================================
  # Build & Test
  # ============================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: paygohub_test
          POSTGRES_USER: paygohub
          POSTGRES_PASSWORD: paygohub123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test tests/PayGoHub.Tests --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx" --logger "html;LogFileName=test-results.html" --collect:"XPlat Code Coverage"
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=paygohub_test;Username=paygohub;Password=paygohub123"

      - name: Install ReportGenerator
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Generate HTML Coverage Report
        if: always()
        run: |
          ~/.dotnet/tools/reportgenerator \
            -reports:"**/TestResults/**/coverage.cobertura.xml" \
            -targetdir:"TestResults/CoverageReport" \
            -reporttypes:"Html;HtmlSummary;Badges;TextSummary" \
            -title:"PayGoHub Test Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/TestResults/*.trx
            **/TestResults/*.html

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-html-report
          path: TestResults/CoverageReport/

  # ============================================================================
  # Code Quality
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'

      - name: Restore dependencies
        run: dotnet restore

      - name: Check formatting
        run: dotnet format --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: Build with warnings as errors
        run: dotnet build --no-restore --configuration Release /warnaserror
        continue-on-error: true

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'

      - name: Restore dependencies
        run: dotnet restore

      - name: Check for vulnerable packages
        run: dotnet list package --vulnerable --include-transitive 2>&1 | tee security-report.txt
        continue-on-error: true

      - name: Check for outdated packages
        run: dotnet list package --outdated 2>&1 | tee outdated-report.txt
        continue-on-error: true

      - name: Generate HTML Security Report
        if: always()
        run: |
          cat > security-report.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>PayGoHub Security Report</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
              h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
              h2 { color: #555; margin-top: 30px; }
              .report-section { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 13px; }
              .timestamp { color: #666; font-size: 14px; }
              .status-ok { color: #28a745; font-weight: bold; }
              .status-warn { color: #ffc107; font-weight: bold; }
              .status-error { color: #dc3545; font-weight: bold; }
            </style>
          </head>
          <body>
            <h1>üîí PayGoHub Security Report</h1>
            <p class="timestamp">Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>

            <div class="report-section">
              <h2>üõ°Ô∏è Vulnerability Scan</h2>
              <pre>$(cat security-report.txt)</pre>
            </div>

            <div class="report-section">
              <h2>üì¶ Outdated Packages</h2>
              <pre>$(cat outdated-report.txt)</pre>
            </div>
          </body>
          </html>
          EOF

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security-report.txt
            outdated-report.txt
            security-report.html

  # ============================================================================
  # Docker Build
  # ============================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: paygohub:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker build -t paygohub:test .
          docker run -d --name paygohub-test -p 8080:8080 \
            -e ASPNETCORE_ENVIRONMENT=Production \
            -e "ConnectionStrings__DefaultConnection=Host=localhost;Database=test;Username=test;Password=test" \
            paygohub:test || true
          sleep 5
          docker logs paygohub-test
          docker stop paygohub-test || true
          docker rm paygohub-test || true

  # ============================================================================
  # Integration Tests (with Docker Compose)
  # ============================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start services
        run: docker compose up -d db

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if docker compose exec -T db pg_isready -U paygohub -d paygohub; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'

      - name: Run integration tests
        run: dotnet test --filter "Category=Integration" --verbosity normal --logger "trx;LogFileName=integration-results.trx" --logger "html;LogFileName=integration-results.html"
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Port=5433;Database=paygohub;Username=paygohub;Password=paygohub123"
        continue-on-error: true

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-results
          path: |
            **/TestResults/*.trx
            **/TestResults/*.html

      - name: Stop services
        if: always()
        run: docker compose down -v

  # ============================================================================
  # E2E Tests (Playwright .NET) - Manual trigger or [e2e] in commit
  # ============================================================================
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[e2e]')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build E2E project
        run: dotnet build tests/PayGoHub.E2E --configuration Release

      - name: Install Playwright browsers
        run: pwsh tests/PayGoHub.E2E/bin/Release/net10.0/playwright.ps1 install --with-deps chromium

      - name: Start full stack
        run: docker compose up -d --build

      - name: Wait for application
        run: |
          for i in {1..60}; do
            if curl -s http://localhost:5000/health | grep -q "healthy"; then
              echo "Application is ready!"
              break
            fi
            echo "Waiting for application... ($i/60)"
            sleep 5
          done

      - name: Run E2E tests
        run: dotnet test tests/PayGoHub.E2E --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=e2e-results.trx" --logger "html;LogFileName=e2e-results.html"
        env:
          BASE_URL: http://localhost:5000

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results
          path: |
            **/TestResults/*.trx
            **/TestResults/*.html
            **/TestResults/*.png

      - name: Stop services
        if: always()
        run: docker compose down -v
