name: Deploy to Fly.io

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Verify Fly.io authentication
        run: flyctl auth whoami

      - name: Deploy to Fly.io
        run: |
          echo "Deploying to ${{ github.event.inputs.environment || 'staging' }}..."
          flyctl deploy --remote-only

      - name: Run database migrations
        run: |
          echo "Running database migrations..."
          flyctl ssh console -C "cd /app && dotnet ef database update" || true

      - name: Verify deployment
        run: |
          echo "Verifying deployment health..."
          APP_URL=$(flyctl status --json | jq -r '.Hostname')

          for i in {1..10}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "https://${APP_URL}/health" || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "✓ Deployment healthy!"
              break
            fi
            echo "Waiting for health check... ($i/10)"
            sleep 10
          done

          if [ "$RESPONSE" != "200" ]; then
            echo "⚠ Health check did not return 200"
          fi

      - name: Post deployment summary
        run: |
          APP_URL=$(flyctl status --json | jq -r '.Hostname')

          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** https://${APP_URL}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Notify failure
        run: |
          echo "Deployment failed! Check the logs."
          # Add Slack/Teams notification here if needed
